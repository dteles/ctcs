------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  D:\Users\dteles\Box Sync\DTeles\CharitableTaxCredits\ctcs_dofiles\CharitableTaxCredits_20170821_091002.log
  log type:  text
 opened on:  21 Aug 2017, 09:10:02
.         pwd
D:\Users\dteles\Box Sync\DTeles\CharitableTaxCredits\ctcs_dofiles
.         display "$S_DATE $S_TIME"
21 Aug 2017 09:10:02
. }

. di "-------------------------"
-------------------------

. di "`c(username)' `c(current_date)'"
dteles 21 Aug 2017

. di "`c(current_time)'"
09:10:02

. di "-------------------------"
-------------------------

. 
. **************************************************
. * Net Installs ensure all programs are loaded
. **************************************************
. /* right now, we don't need these
> ssc install sutex
> ssc install estout, replace
> ssc install mat2txt
> net install outtable, from("http://fmwww.bc.edu/RePEc/bocode/o/") replace
> ssc install egenmore, replace
> ssc install spmap, replace
> ssc install corrtex
> ssc install avar, replace
> ssc install weakiv, replace
> ssc install ivreg2, replace
> ssc install xtivreg2, replace
> ssc install ranktest, replace
> ssc install synth, replace
> ssc install matsave
> ssc install labutil, replace
> ssc install carryforward, replace
> ssc install unique, replace
> */
. 
. **************************************************
. * Create Datasets
. **************************************************
. 
. do CTC_makedata.do

. *************************************************
. * Charitable Tax Credits Analysis
. * CTC_makedata.do
. * 8/21/2017, version 1
. * Dan Teles
. *************************************************
. * this file creates datasets 
. * it can be called from CharitableTaxCredits.do
. **************************************************
. * Directories
. **************************************************
. local projectdir="D:\Users\dteles\Box Sync\DTeles\CharitableTaxCredits"

. local datadir="`projectdir'\data"

. local output="`projectdir'\output"

. local project="CharitableTaxCredits"

. **************************************************
. * Locals to define which sections to run
. **************************************************
. local mergeNCCS="no"

. local statefiles="yes"

. **************************************************
. * Save Time-stamped copy of this .do file
. **************************************************
. if "$makecopy"=="yes"{
.         local time : di %tcCCYYNNDD!_HHMMSS clock("`c(current_date)'`c(current_time)'","DMYhms")
.         copy CTC_makedata.do "CTC_makedata_`time'.do"
. }

. **************************************************
. * Create Datasets
. **************************************************
. *Create 1989-2009 temp files
. **************************
. if "`mergeNCCS'"=="yes" {
.         foreach num of numlist 1989/2009 {
  2.                 cd "`datadir'\NCCSextracts"
  3.                 use CorePC`num', replace
  4.                 if `num'==1990 {
  5.                         *keep variables of interest
.                         keep ein fisyr name-zip5 cont dues invinc totrev solicit ass_boy-liab_eoy fundfees compens
  6.                         gen progrev=0  // generate program revenue variable
  7.                 }
  8.                 if `num'==2008 | `num'==2009 {
  9.                         keep ein fisyr name-zip5 cont progrev dues invinc totrev solicit ass_boy-liab_eoy fundfees 
> direxp rentexp compens
 10.                         ***Edit Fundraising Expenses for consistancy after change in 990 Form
.                         replace solicit=fundfees+direxp if fundfees+direxp>solicit & fundfees!=. & direxp!=.
 11.                         replace solicit=fundfees+direxp if solicit==0 | solicit==.
 12.                 }                       
 13.                 if `num'!=1990 & `num'!=2008 & `num'!=2009 {
 14.                         keep ein fisyr name-zip5 cont progrev dues invinc totrev solicit ass_boy-liab_eoy fundfees 
> rentexp compens
 15.                 }
 16.                 *Edit Program Revenue Variable for consistancy in measurement across years**
.                 replace progrev=progrev+dues
 17.                 drop dues       
 18.                 *destring for help with merge and sort.
.                 destring ein fisyr , replace force
 19.                 recast long ein
 20.                 *generate a variable for which version the data came from
.                 gen yr_filed = `num'
 21.                 *save temp file*
.                 cd "`datadir'\temp"
 22.                 save CorePC`num'_temp, replace
 23.         }
.         **************************
.         *Create 2010 temp file
.         **************************
.         cd "`datadir'\NCCSextracts"
.         use CorePC2010, replace
.         keep ein fisyr name-zip5 cont progrev dues invinc totrev solicit ass_boy-liab_eoy fundfees direxp rentexp comp
> ens
.         *Edit Program Revenue Variable for consistancy in measurement across years**
.         replace progrev=progrev+dues
.         drop dues
.         *Edit Fundraising Expenses for consistancy after change in 990 Form
.         replace solicit=fundfees+direxp if fundfees+direxp>solicit & fundfees!=. & direxp!=.
.         replace solicit=fundfees+direxp if solicit==0 | solicit==.
.         *destring for help with merge and sort.
.         destring ein fisyr , replace
.         recast long ein
.         *generate a variable for which version the data came from
.         gen yr_filed = 2010
.         cd "`datadir'\temp"
.         save CorePC2010_temp, replace
.         **************************
.         *Create 2011 temp file
.         **************************
.         cd "`datadir'\NCCSextracts"
.         use CorePC2011, replace
.         keep ein fisyr name-zip5 cont progrev invinc totrev ass_boy-liab_eoy fundfees lessdirf lessdirg rentexp compen
> s
.         ***Edit Fundraising Expenses for consistancy after change in 990 Form
.         gen solicit=fundfees+lessdirf+lessdirg
.         ****destring for help with merge and sort.
.         destring ein fisyr , replace
.         recast long ein
.         ****generate a variable for which version the data came from
.         gen yr_filed = 2011
.         cd "`datadir'\temp"
.         save CorePC2011_temp, replace
.         *******************************************
.         *Create 2012 and 2013 temp files
.         *******************************************
.         foreach num of numlist 2012/2013 {
  2.                 cd "`datadir'\NCCSextracts"     
  3.                 use CorePC`num', replace
  4.                 keep ein fisyr name-zip5 cont progrev invinc totrev ass_boy-liab_eoy lessdirf fundfees lessdirf les
> sdirg rentexp compens
  5.                         ***Edit Fundraising Expenses for consistancy after change in 990 Form
.                         gen solicit=fundfees+lessdirf+lessdirg  
  6.                         ****destring for help with merge and sort.
.                         destring ein fisyr , replace
  7.                         recast long ein
  8.                         ****generate a variable for which version the data came from
.                         gen yr_filed = 2012
  9.                 ***Save 2012temp file***
.                 cd "`datadir'\temp"
 10.                 save CorePC`num'_temp, replace
 11.         }
.         *********************************************
.         *Merge Temp files into a Master file and Clean Data
.         *********************************************
.         use CorePC1989_temp, replace
.         foreach num of numlist 1990/2013 {
  2.                 cd "`datadir'\temp"
  3.                 append using CorePC`num'_temp
  4.         }
.         **remove duplicates*****
.         ***first, if duplicate entries exist within the same fiscal year and filing year, take the larger values of fi
> nancial variables
.         sort ein fisyr yr_filed
.         order ein fisyr yr_filed
.         collapse  (first) name-zip5 (max) cont-compens, by(ein fisyr yr_filed)
.         ***second treat duplicates from filings in seperate years as ammended files.
.         sort ein fisyr yr_filed /*sorts by year filed*/
.         by ein fisyr: gen N=_N
.         by ein fisyr: gen n=_n
.         count
.         **Keeps only the last filing***
.         keep if N==n
.         drop N n
.         count
.         *clean string data
.         foreach var of varlist name state city {
  2.                 replace `var'=upper(`var')
  3.                 replace `var' = subinstr(`var', "&", " AND ",.)
  4.                 replace `var' = subinstr(`var', "-", " ",.)
  5.                 replace `var' = subinstr(`var', "/", " ",.)
  6.                 replace `var' = subinstr(`var', ",", " ",.)
  7.                 replace `var' = subinstr(`var', "INCORPORATED", "INC.",.)
  8.                 replace `var' = subinstr(`var', "CORPORRN", "CORP.",.)
  9.                 replace `var' = subinstr(`var', "  ", " ",.)
 10.                 replace `var' = subinstr(`var', "  ", " ",.)
 11.                 egen `var'2=sieve(`var'), keep(alphabetic numeric space)
 12.                 replace `var'=`var'2
 13.                 drop `var'2
 14.                 replace `var'=trim(`var')
 15.                 replace `var'=trim(`var')
 16.         }       
.         ***Save Combined Project File**********
.         cd "`datadir'"
.         save CombinedNCCS, replace
. }       

. *********************************************
. *Create State-by-NTEECC and State Aggregate Files
. *********************************************
. if "`statefiles'"=="yes" {
.         * load data *
.         if "`mergeNCCS'"=="no" {
.                 cd "`datadir'"
D:\Users\dteles\Box Sync\DTeles\CharitableTaxCredits\data
.                 use CombinedNCCS, replace
.         }       
.         **Gen Number Variable
.         gen nonprofits=1
.         ***fill in state variable if missing
.         sort ein fisyr
.                 bysort ein: carryforward state if state=="", replace
state:  (2,137 real changes made)
.                 bysort ein: carryforward state if state=="", replace
state:  (0 real changes made)
.                 gsort ein - fisyr
.                 by ein : carryforward state if state=="", replace 
state:  (1,066 real changes made)
.                 by ein: carryforward state if state=="", replace
state:  (0 real changes made)
.                 count if state==""
  1,033
.         ***Collapse to State by NCCS by Year    
.         sort state nteecc ein fisyr
.         collapse (sum) cont-compens nonprofits, by(state nteecc fisyr)
.         ****Save State-by-NTEECC File****
.         cd "`datadir'"
D:\Users\dteles\Box Sync\DTeles\CharitableTaxCredits\data
.         save NCCS_ntee_state_year, replace      
file NCCS_ntee_state_year.dta saved
.         ***Collapse to State by Year
.         sort state fisyr nteecc 
.         collapse (sum) cont-compens nonprofits, by(state fisyr)
.         ****Save State Aggregate File****
.         cd "`datadir'"
D:\Users\dteles\Box Sync\DTeles\CharitableTaxCredits\data
.         save NCCS_state_year, replace   
file NCCS_state_year.dta saved
. }

. 
end of do-file

. 
. 
. 
. **************************************************
. * Close the log, end the file
. **************************************************
. macro drop _all

. capture log close
